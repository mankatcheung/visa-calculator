name: Test
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'
      - name: Install dependencies
        run: yarn install
      - name: Run lint
        run: yarn run lint
      - name: Run tests with coverage
        run: yarn run coverage
      - name: Install Turso CLI
        run: curl -sSfL https://get.tur.so | bash
      - name: Run local SQLite database with Turso
        run: turso dev
      - name: Run database migrations
        run: yarn db:migrate
        env:
          E2E_DATABASE_URL: http://127.0.0.1:8080
      - name: Build Nextjs Project
        run: yarn build
        env:
          E2E_DATABASE_URL: http://127.0.0.1:8080
      - name: Start Nextjs project
        run: yarn start &
        env:
          E2E_DATABASE_URL: http://127.0.0.1:8080
      - name: Wait for Next.js to be ready
        run: npx wait-on http://localhost:3000 --timeout 30000
      - name: Run Cypress e2e tests
        run: yarn cy:run
      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
